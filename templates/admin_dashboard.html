{% extends "base.html" %}

{% block main %}
<!-- Main admin dashboard container (full width with padding) -->
<div class="container-fluid px-4">

    <!-- Dashboard heading and logged-in admin indicator -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Admin Dashboard</h2>
        <span class="badge bg-dark">Logged in as: {{ session.username }}</span>
    </div>

    <!-- 1. Total Revenue Summary part -->
    <!-- Displays total confirmed/paid revenue across all hotels -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card bg-success text-white shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title">Total Sales Revenue</h5>
                    <h1 class="display-4 fw-bold">£{{ total_sales }}</h1>
                    <p class="mb-0">Confirmed Bookings Only</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ADD NEW HOTEL BRANCH -->
    <!-- Admin form to add a new hotel with peak and off-peak prices -->
    <div class="card shadow-sm mb-4">
    <div class="card-header bg-dark text-white"><h5>Add New Hotel Branch</h5></div>
    <div class="card-body">
        <form action="/admin/add_hotel" method="POST" class="row g-3">
            <div class="col-md-4">
                <input type="text" name="city" class="form-control" placeholder="City Name (e.g. Liverpool)" required>
            </div>
            <div class="col-md-3">
                <input type="number" name="peak" class="form-control" placeholder="Peak Rate (£)" required>
            </div>
            <div class="col-md-3">
                <input type="number" name="off" class="form-control" placeholder="Off-Peak Rate (£)" required>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-success w-100">Add Hotel</button>
            </div>
        </form>
    </div>
</div>

    <!-- 2. Hotel Reports &  Management -->
    <!-- admin table for price updates, revenue, profit and actions -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Hotel Management & Reports</h4>
        </div>
        <div class="card-body">
            <!-- Responsive table wrapper -->
            <div class="table-responsive">
                <table class="table table-bordered align-middle">
                    <thead style="background:#1f3d2b; color:white;">

                        <tr>
                            <th style="width: 15%;">City</th>
                            <th style="width: 25%;">Current Rates (Peak/Off)</th>
                            <th style="width: 30%;">Update Prices</th>
                            <th>Revenue</th>
                            <th>Profit (£)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for h in hotel_stats %}
                        <tr>
                            <td class="fw-bold">{{ h.city }}</td>
                            <td>
                                <small class="text-muted">Peak:</small> £{{ h.peak_rate }}<br>
                                <small class="text-muted">Off:</small> £{{ h.off_peak_rate }}
                            </td>
                            <td>

                                <!-- update price form -->
                                <form action="/admin/update_price" method="POST" class="d-flex gap-2">
                                    <input type="hidden" name="hotel_id" value="{{ h.id }}">
                                    
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">P</span>
                                        <input type="number" name="peak_rate" value="{{ h.peak_rate|int }}" class="form-control" style="width: 50px;" required>
                                    </div>
                                    
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">O</span>
                                        <input type="number" name="off_peak_rate" value="{{ h.off_peak_rate|int }}" class="form-control" style="width: 50px;" required>
                                    </div>

                                    <button type="submit" class="btn btn-sm btn-warning">Set</button>
                                </form>
                            </td>

                            <!-- Revenue column -->
                            <td class="fw-bold text-success">
                                 £{{ h.revenue | money }}
                            </td>
                            <!-- Profit column -->
                            <td class="fw-bold text-dark">
                                £{{ h.profit }}
                            </td>
                            <!-- Hotel actions -->
                            <td>
                                <div class="d-flex gap-1">
                                    <a href="/admin/manage_rooms/{{ h.id }}" class="btn btn-sm btn-info text-white">Rooms</a>
                                    <a href="/admin/delete_hotel/{{ h.id }}" class="btn btn-sm btn-danger" 
                                        onclick="return confirm('Delete this hotel and all its rooms?')">Delete</a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- 3. Quick Actions -->
    <div class="row">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Inventory Management</h5>
                    <p class="card-text">Reset database rooms to default (30% Std / 50% Dbl / 20% Fam).</p>
                    <a href="/seed_rooms" class="btn btn-outline-danger w-100" onclick="return confirm('This will attempt to generate rooms again. Only do this if database is empty.');">Generate Room Inventory</a>
                </div>
            </div>
        </div>
        <div class="col-md-6">
             <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">User View</h5>
                    <p class="card-text">Go to the home page to search and book like a regular customer.</p>
                    <a href="/" class="btn btn-outline-primary w-100">Go to Home Page</a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header bg-dark text-white"><h4>Currency Exchange Rates</h4></div>
    <div class="card-body">
        <form action="/admin/update_exchange" method="POST" class="row g-3">
            <div class="col-md-5">
                <label>USD Rate (1 GBP = ? USD)</label>
                <input type="number" step="0.01" name="usd_rate" class="form-control" placeholder="e.g. 1.25">
            </div>
            <div class="col-md-5">
                <label>EUR Rate (1 GBP = ? EUR)</label>
                <input type="number" step="0.01" name="eur_rate" class="form-control" placeholder="e.g. 1.18">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">Update Rates</button>
            </div>
        </form>
    </div>
</div>

<div class="row mb-4">
    <!-- 1. Monthly Sales Report Card -->
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Monthly Sales Performance</h5>
            </div>
            <div class="card-body">
                <table class="table table-bordered table-hover align-middle shadow-sm">
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th class="text-end">Revenue (£)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for m in monthly_sales %}
                        <tr>
                            <td>{{ m.month }}</td>
                            <!-- Using format filter to fix long decimals -->
                            <td class="text-end fw-bold">£{{ "%.2f"|format(m.revenue or 0) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 2. Top Customers Card -->
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-star-fill"></i> Top Spending Customers</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    {% for c in top_customers %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-person-circle text-primary me-2"></i>
                            {{ c.username }}
                        </div>
                        <span class="badge bg-success rounded-pill px-3">
                            £{{ "%.2f"|format(c.spent or 0) }}
                        </span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- 3. Password Management Card -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0"><i class="bi bi-shield-lock"></i> Administrative Password Override</h5>
    </div>
    <div class="card-body">
        <p class="text-muted small">Update a user's password directly from the console. Use only for support requests.</p>
        <form method="POST" action="{{ url_for('admin_change_password') }}" class="row g-3 align-items-end">
            <div class="col-md-5">
                <label class="form-label fw-bold">Select User Account</label>
                <select name="username" id="username" class="form-select border-dark">
                    {% for user in users %}
                    <option value="{{ user.username }}">{{ user.username }} ({{ user.email }})</option>
                    
                    {% endfor %}
                </select>
            
            </div>
            <div class="col-md-5">
                <label class="form-label fw-bold">Set New Password</label>
                <input type="password" name="new_password" class="form-control border-dark" placeholder="Enter secure password" required>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-dark w-100 fw-bold">
                    Update Password
                </button>
            </div>
        </form>
    </div>
</div>

<!-- 4. Admin Profile Change -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0"><i class="bi bi-person-circle"></i> My Profile</h5>
    </div>
    <div class="card-body d-flex gap-2">
        <a href="{{ url_for('change_password') }}" class="btn btn-warning btn-sm fw-bold">
            Change My Password
        </a>
        <a href="{{ url_for('change_email') }}" class="btn btn-info btn-sm fw-bold">
            Change My Email
        </a>
    </div>
</div>

{% endblock %}
